<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
       "DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
  <title>README</title>
</head>

<body>
<h1>Engaging Sandesha2/C Module</h1>
<p>
  Install sandesha2 module into &lt;axis2 deploy folder&gt;/modules folder. Add the RMPhase
  information into axis2.xml as following. Search for 'RMPhase' in the
  following xml block to identify the RM specific entries.
</p>
<pre>
    &lt;!-- ================================================= --&gt;
    &lt;!-- Phases  --&gt;
    &lt;!-- ================================================= --&gt;
    &lt;phaseOrder type="inflow"&gt;
        &lt;!--  System pre defined phases       --&gt;
        &lt;phase name="TransportIn"/&gt;
        &lt;phase name="PreDispatch"/&gt;
        &lt;phase name="Dispatch"&gt;
            &lt;handler name="AddressingBasedDispatcher"
                     class="axis2_engine"&gt;
                &lt;order phase="Dispatch"/&gt;
            &lt;/handler&gt;
             &lt;handler name="RequestURIBasedDispatcher"
                     class="axis2_engine"&gt;
                &lt;order phase="Dispatch"/&gt;
            &lt;/handler&gt;
             &lt;handler name="SOAPActionBasedDispatcher"
                     class="axis2_engine"&gt;
                &lt;order phase="Dispatch"/&gt;
            &lt;/handler&gt;
             &lt;handler name="SOAPMessageBodyBasedDispatcher"
                     class="axis2_engine"&gt;
                &lt;order phase="Dispatch"/&gt;
            &lt;/handler&gt;
        &lt;/phase&gt;
        &lt;phase name="PostDispatch"&gt;
             &lt;handler name="DispatchPostConditionsEvaluator"
                     class="axis2_engine"&gt;
                &lt;order phase="PostDispatch"/&gt;
            &lt;/handler&gt;
            &lt;handler name="InstanceDispatcher"
                     class="axis2_engine"&gt;
                &lt;order phase="PostDispatch"/&gt;
            &lt;/handler&gt;
            &lt;handler name="SOAPProcessingModelChecker"
                     class="axis2_engine"&gt;
                &lt;order phase="PostDispatch"/&gt;
            &lt;/handler&gt;
        &lt;/phase&gt;
        &lt;!--  System pre defined phases       --&gt;
        &lt;!--   After Postdispatch phase module author or or service author can add any phase he want      --&gt;
        &lt;!--phase name="userphase1"/--&gt;
        &lt;phase name="RMPhase"/&gt;
    &lt;/phaseOrder&gt;
    &lt;phaseOrder type="outflow"&gt;
        &lt;!--      user can add his own phases to this area  --&gt;
    &lt;phase name="RMPhase"/&gt;
        &lt;!--phase name="userphase1"/--&gt;
        &lt;!--system predefined phase--&gt;
        &lt;!--these phase will run irrespective of the service--&gt;
        &lt;!--phase name="PolicyDetermination"/--&gt;
        &lt;!--phase name="MessageOut"/--&gt;
    &lt;/phaseOrder&gt;
    &lt;phaseOrder type="INfaultflow"&gt;
        &lt;!--      user can add his own phases to this area  --&gt;
        &lt;!--phase name="userphase1"/--&gt;
	    &lt;phase name="RMPhase"/&gt;
    &lt;/phaseOrder&gt;
    &lt;phaseOrder type="Outfaultflow"&gt;
        &lt;!--      user can add his own phases to this area  --&gt;
        &lt;phase name="RMPhase"/&gt;
        &lt;phase name="MessageOut"/&gt;
        &lt;!--phase name="userphase1"/--&gt;
        &lt;!--phase name="PolicyDetermination"/--&gt;
    &lt;/phaseOrder&gt;
</pre>
<p>
In the services xml file for the service which require RM enabled
add the entry
 &lt;module ref="sandesha2"/&gt;
If you need all services in the engine RM enabled add the above entry into
axis2.xml.
</p>
<p>
You can use samples in the samples folder for testing.
</p>

<h2>Known Issues</h2>

Please keep in mind the following when using Sandesha2/C with Axis2/C.
<ol>
<li>Comment the line no:295 in src/core/transport/http/receiver/http_svr_thread.c
   <pre>axutil_free_thread_env(thread_env);</pre>
</li>

<li>Comment the line no:299 in src/core/transport/http/receiver/http_svr_thread.c
    <pre>axutil_thread_pool_exit_thread(env-&gt;thread_pool, thd);</pre>
</li>
<li>Comment the following block starting form line no:259 src/core/transport/http/sender/http_sender.c
<pre>
    property = axutil_property_create(env);
    axutil_property_set_scope(property, env, AXIS2_SCOPE_REQUEST);
    axutil_property_set_free_func(property, env, axis2_http_client_free_void_arg);
    axutil_property_set_value(property, env, sender-&gt;client);
    axis2_msg_ctx_set_property(msg_ctx, env, AXIS2_HTTP_CLIENT, property);
</pre>
</li>
<li>If for some reason RM sequences seems not executing properly the reason could
   be the database is corrupted for some reason. Try rerunning the  the database
   scripts to clean the database.
</li>
</ol>
Some of the above changes may lead to memory leaks in Axis2/C. 
</body>
</html>
